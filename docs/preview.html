<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>さんぽAI 設計図プレビュー</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
        h1 { border-bottom: 2px solid #2FA84F; padding-bottom: 10px; }
        h2 { margin-top: 40px; background-color: #f0f0f0; padding: 10px; border-left: 5px solid #2FA84F; }
        .mermaid { text-align: center; margin: 20px 0; }
        .description { background: #f9f9f9; padding: 15px; border-radius: 5px; line-height: 1.6; }
    </style>
    <!-- Mermaid 10 is ESM only. Using module script. -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>
</head>
<body>
    <h1>さんぽAI システム設計図</h1>
    <p>このファイルはブラウザで開くことで、Mermaid記法の図をレンダリングして確認できます。</p>
    <p style="color: #666; font-size: 0.9em;">※ 表示されない場合は、ブラウザのキャッシュをクリアするか、別のブラウザ（Chrome/Edge等）をお試しください。</p>

    <h2>1. ユースケース図</h2>
    <div class="mermaid">
flowchart LR
    User["User"]
    GMaps["Google Maps API"]
    Firebase["Firebase Auth"]
    WeatherAPI["OpenWeatherMap API"]

    subgraph "Sanpo AI (HM Shop)"
        UC1(("Login / Register"))
        UC2(("Logout"))
        UC3(("Search Route"))
        UC4(("Show Map & Route"))
        UC5(("Search Spots"))
        UC6(("Check Steps / Distance"))
        UC7(("Check Weather"))
    end

    User --> UC1
    User --> UC2
    User --> UC3
    User --> UC4
    User --> UC6
    User --> UC7

    UC1 -. Auth .-> Firebase
    UC2 -. Sign out .-> Firebase
    UC3 -. Directions API .-> GMaps
    UC4 -. Maps SDK .-> GMaps
    UC5 -. Places API .-> GMaps
    UC5 -. extend .-> UC3
    UC7 -. Weather .-> WeatherAPI
    </div>

    <h2>2. クラス図</h2>
    <div class="mermaid">
classDiagram
    %% =========================
    %% Main Page
    %% =========================
    class MainPage {
        -TextEditingController _originController
        -TextEditingController _destController
        -Set~String~ _selectedFilters
        -WalkMapWidget mapWidget
        +initState()
        +build()
        -_updateRoute()
        -_loadAppVersion()
    }

    %% =========================
    %% Map Widget
    %% =========================
    class WalkMapWidget {
        +String origin
        +String destination
        +String? waypoint
        +Set~String~ filters
        -Set~Marker~ _markers
        -Set~Polyline~ _polylines
        +createState()
        -_getRoute()
        -_loadPlacesAlongRoute()
    }

    %% =========================
    %% Services
    %% =========================
    class AuthService {
        -FirebaseAuth _auth
        +bool isAuthenticated
        +signIn(email, password)
        +signOut()
        +register(email, password)
    }

    class StepService {
        -Map~String, int~ _dailySteps
        +saveStep(date, steps)
        +getStepsForDate(date)
        +getLast7DaysKm()
        +clearAllData()
    }

    %% =========================
    %% UI Components
    %% =========================
    class WeatherPanel {
        +String originName
        +String destinationName
        +onSystemCommentChanged
    }

    class StepCounter {
        +build()
    }

    class WeeklyDistanceChart {
        +build()
    }

    %% =========================
    %% External API
    %% =========================
    class GoogleMapsAPI {
        &lt;&lt;external&gt;&gt;
    }

    %% =========================
    %% Relationships
    %% =========================
    MainPage --> AuthService : uses (Provider)
    MainPage --> StepService : uses (Provider)

    MainPage *-- WalkMapWidget : composes
    MainPage *-- StepCounter : composes
    MainPage *-- WeeklyDistanceChart : composes
    MainPage *-- WeatherPanel : composes

    WalkMapWidget ..> GoogleMapsAPI : calls
    </div>

    <h2>3. シーケンス図</h2>
    <div class="mermaid">
sequenceDiagram
    autonumber
    actor User as ユーザー
    participant Main as MainPage
    participant Map as WalkMapWidget
    participant GDir as Google Directions API
    participant GPlace as Google Places API

    User->>Main: 出発地・目的地を入力
    User->>Main: フィルタ「コンビニさんぽ」を選択
    User->>Main: 入力確定 (フォーカスアウト)
    activate Main
    Main->>Main: _updateRoute()
    Main->>Map: 再描画 (origin, dest, filters)
    deactivate Main

    activate Map
    Map->>Map: _loadRouteAndPlaces()
    
    Map->>GDir: 経路検索リクエスト (origin, dest, mode=walking)
    activate GDir
    GDir-->>Map: 経路データ (JSON)
    deactivate GDir

    Map->>Map: ルート描画 (_polylines.add)
    Map->>Map: 出発・到着マーカー追加 (_markers.add)

    alt フィルタあり (コンビニさんぽ)
        Map->>Map: _sampleRoute(route)
        loop サンプリング地点ごと
            Map->>GPlace: 周辺検索 (type=convenience_store)
            activate GPlace
            GPlace-->>Map: 施設リスト
            deactivate GPlace
        end
        Map->>Map: 施設マーカー追加 (_markers.add)
    end

    Map-->>User: 地図更新 (ルート・マーカー表示)
    deactivate Map
    </div>
</body>
</html>
